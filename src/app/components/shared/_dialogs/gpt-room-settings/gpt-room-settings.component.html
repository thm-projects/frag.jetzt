<h3>{{ "gpt-room-settings.title" | translate }}</h3>

<mat-dialog-content *ngIf="!isLoading; else loading">
  <!-- GPT over frag.jetzt -->
  <h3>{{ "gpt-room-settings.trial-info" | translate }}</h3>
  <ng-container *ngIf="!trialEnabled">
    <ng-container *ngIf="isOwner || canChangeApiSettings; else deactivated">
      <mat-form-field>
        <mat-label>{{ "gpt-room-settings.trial-code" | translate }}</mat-label>
        <input
          matInput
          type="password"
          (keydown)="isEnter($event) && activateTrial() || true"
          appAccessibilityEscapedInput
          [(ngModel)]="trialCode" />
      </mat-form-field>
      <button
        mat-button
        (click)="activateTrial()"
        class="primary-btn">
        {{ "gpt-room-settings.send" | translate }}
      </button>
    </ng-container>
  </ng-container>
  <p *ngIf="trialEnabled">
    {{ "gpt-room-settings.trial-enabled" | translate }}
  </p>

  <!-- GPT from own OpenAI account-->
  <h3>{{ "gpt-room-settings.own-openai-api-key" | translate }}</h3>
  <ng-container *ngIf="isOwner || canChangeApiSettings; else deactivated">
    <p>{{ "gpt-room-settings.own-openai-info" | translate }}</p>
    <mat-form-field>
      <mat-label>{{ "gpt-room-settings.api-key" | translate }}</mat-label>
      <input
        matInput
        appAccessibilityEscapedInput
        [(ngModel)]="apiKey" />
      <button
        *ngIf="apiKey !== null"
        matSuffix
        mat-icon-button
        aria-label="Clear"
        (click)="apiKey = null">
        <mat-icon>close</mat-icon>
      </button>
    </mat-form-field>
    <mat-form-field>
      <mat-label>
        {{ "gpt-room-settings.api-organization" | translate }}
      </mat-label>
      <input
        matInput
        appAccessibilityEscapedInput
        [(ngModel)]="apiOrganization" />
      <button
        *ngIf="apiOrganization !== null"
        matSuffix
        mat-icon-button
        aria-label="Clear"
        (click)="apiOrganization = null">
        <mat-icon>close</mat-icon>
      </button>
    </mat-form-field>
  </ng-container>

  <!-- Room Restrictions -->
  <h3>{{ "gpt-room-settings.restrictions-room" | translate }}</h3>
  <ng-container *ngIf="isOwner || canChangeRoomQuota; else deactivated">
    <mat-form-field>
      <mat-label>{{ "gpt-room-settings.rest-room-acc" | translate }}</mat-label>
      <input
        matInput
        appAccessibilityEscapedInput
        type="number"
        inputmode="numeric"
        pattern="[0-9]*"
        [(ngModel)]="maxAccumulatedRoomQuota" />
      <button
        *ngIf="maxAccumulatedRoomQuota !== null"
        matSuffix
        mat-icon-button
        aria-label="Clear"
        (click)="maxAccumulatedRoomQuota = null">
        <mat-icon>close</mat-icon>
      </button>
    </mat-form-field>
    <mat-form-field>
      <mat-label>
        {{ "gpt-room-settings.rest-room-month" | translate }}
      </mat-label>
      <input
        matInput
        appAccessibilityEscapedInput
        type="number"
        inputmode="numeric"
        pattern="[0-9]*"
        [(ngModel)]="maxMonthlyRoomQuota" />
      <button
        *ngIf="maxMonthlyRoomQuota !== null"
        matSuffix
        mat-icon-button
        aria-label="Clear"
        (click)="maxMonthlyRoomQuota = null">
        <mat-icon>close</mat-icon>
      </button>
    </mat-form-field>
    <mat-form-field>
      <mat-label>{{ "gpt-room-settings.rest-room-day" | translate }}</mat-label>
      <input
        matInput
        appAccessibilityEscapedInput
        type="number"
        inputmode="numeric"
        pattern="[0-9]*"
        [(ngModel)]="maxDailyRoomQuota" />
      <button
        *ngIf="maxDailyRoomQuota !== null"
        matSuffix
        mat-icon-button
        aria-label="Clear"
        (click)="maxDailyRoomQuota = null">
        <mat-icon>close</mat-icon>
      </button>
    </mat-form-field>
  </ng-container>

  <!-- Moderator Restrictions -->
  <h3>{{ "gpt-room-settings.restrictions-moderator" | translate }}</h3>
  <ng-container *ngIf="isOwner || canChangeModeratorQuota; else deactivated">
    <mat-form-field>
      <mat-label>{{ "gpt-room-settings.rest-mod-acc" | translate }}</mat-label>
      <input
        matInput
        appAccessibilityEscapedInput
        type="number"
        inputmode="numeric"
        pattern="[0-9]*"
        [(ngModel)]="maxAccumulatedModeratorQuota" />
      <button
        *ngIf="maxAccumulatedModeratorQuota !== null"
        matSuffix
        mat-icon-button
        aria-label="Clear"
        (click)="maxAccumulatedModeratorQuota = null">
        <mat-icon>close</mat-icon>
      </button>
    </mat-form-field>
    <mat-form-field>
      <mat-label>
        {{ "gpt-room-settings.rest-mod-month" | translate }}
      </mat-label>
      <input
        matInput
        appAccessibilityEscapedInput
        type="number"
        inputmode="numeric"
        pattern="[0-9]*"
        [(ngModel)]="maxMonthlyModeratorQuota" />
      <button
        *ngIf="maxMonthlyModeratorQuota !== null"
        matSuffix
        mat-icon-button
        aria-label="Clear"
        (click)="maxMonthlyModeratorQuota = null">
        <mat-icon>close</mat-icon>
      </button>
    </mat-form-field>
    <mat-form-field>
      <mat-label>{{ "gpt-room-settings.rest-mod-day" | translate }}</mat-label>
      <input
        matInput
        appAccessibilityEscapedInput
        type="number"
        inputmode="numeric"
        pattern="[0-9]*"
        [(ngModel)]="maxDailyModeratorQuota" />
      <button
        *ngIf="maxDailyModeratorQuota !== null"
        matSuffix
        mat-icon-button
        aria-label="Clear"
        (click)="maxDailyModeratorQuota = null">
        <mat-icon>close</mat-icon>
      </button>
    </mat-form-field>
  </ng-container>

  <!-- Participant Restrictions -->
  <h3>{{ "gpt-room-settings.restrictions-participant" | translate }}</h3>
  <ng-container *ngIf="isOwner || canChangeParticipantQuota; else deactivated">
    <mat-form-field>
      <mat-label>{{ "gpt-room-settings.rest-part-acc" | translate }}</mat-label>
      <input
        matInput
        appAccessibilityEscapedInput
        type="number"
        inputmode="numeric"
        pattern="[0-9]*"
        [(ngModel)]="maxAccumulatedParticipantQuota" />
      <button
        *ngIf="maxAccumulatedParticipantQuota !== null"
        matSuffix
        mat-icon-button
        aria-label="Clear"
        (click)="maxAccumulatedParticipantQuota = null">
        <mat-icon>close</mat-icon>
      </button>
    </mat-form-field>
    <mat-form-field>
      <mat-label>
        {{ "gpt-room-settings.rest-part-month" | translate }}
      </mat-label>
      <input
        matInput
        appAccessibilityEscapedInput
        type="number"
        inputmode="numeric"
        pattern="[0-9]*"
        [(ngModel)]="maxMonthlyParticipantQuota" />
      <button
        *ngIf="maxMonthlyParticipantQuota !== null"
        matSuffix
        mat-icon-button
        aria-label="Clear"
        (click)="maxMonthlyParticipantQuota = null">
        <mat-icon>close</mat-icon>
      </button>
    </mat-form-field>
    <mat-form-field>
      <mat-label>{{ "gpt-room-settings.rest-part-day" | translate }}</mat-label>
      <input
        matInput
        appAccessibilityEscapedInput
        type="number"
        inputmode="numeric"
        pattern="[0-9]*"
        [(ngModel)]="maxDailyParticipantQuota" />
      <button
        *ngIf="maxDailyParticipantQuota !== null"
        matSuffix
        mat-icon-button
        aria-label="Clear"
        (click)="maxDailyParticipantQuota = null">
        <mat-icon>close</mat-icon>
      </button>
    </mat-form-field>
  </ng-container>

  <!-- Keywords -->
  <h3>{{ "gpt-room-settings.keywords" | translate }}</h3>
  <ng-container *ngIf="isOwner || canChangeKeywords; else deactivated">
    <mat-form-field>
      <mat-label>{{ "gpt-room-settings.add-keyword" | translate }}</mat-label>
      <input
        matInput
        appAccessibilityEscapedInput
        (keydown)="isEnter($event) && addKeyword() || true"
        [(ngModel)]="keywordAdd" />
      <button
        *ngIf="keywordAdd"
        matSuffix
        mat-icon-button
        aria-label="Add"
        (click)="addKeyword()">
        <mat-icon>check</mat-icon>
      </button>
    </mat-form-field>
    <mat-list>
      <mat-list-item
        class="keyword-item"
        *ngFor="let item of keywords; let i = index">
        <div matListItemTitle>{{ item }}</div>
        <button mat-icon-button>
          <mat-icon (click)="keywords.splice(i, 1)">close</mat-icon>
        </button>
      </mat-list-item>
    </mat-list>
  </ng-container>

  <!-- Usage times -->
  <h3>{{ "gpt-room-settings.usage-times" | translate }}</h3>
  <ng-container *ngIf="isOwner || canChangeUsageTimes; else deactivated">
    <p>{{ "gpt-room-settings.usage-time-info" | translate }}</p>
    <div class="time-select">
      <span>
        <mat-label>{{ "gpt-room-settings.start-time" | translate }}</mat-label>
        <ngx-mat-timepicker [(ngModel)]="startDate"></ngx-mat-timepicker>
      </span>
      <span>
        <mat-label>{{ "gpt-room-settings.end-time" | translate }}</mat-label>
        <ngx-mat-timepicker [(ngModel)]="endDate"></ngx-mat-timepicker>
      </span>
    </div>
    <mat-form-field>
      <mat-label>
        {{ "gpt-room-settings.start-and-end-date" | translate }}
      </mat-label>
      <mat-date-range-input
        [formGroup]="dateRange"
        [rangePicker]="dateRangePicker">
        <input
          matStartDate
          formControlName="start" />
        <input
          matEndDate
          formControlName="end" />
      </mat-date-range-input>
      <mat-hint>
        {{ getDateFormatString() }} â€“ {{ getDateFormatString() }}
      </mat-hint>
      <mat-datepicker-toggle
        matSuffix
        [for]="dateRangePicker"></mat-datepicker-toggle>
      <mat-date-range-picker #dateRangePicker></mat-date-range-picker>
    </mat-form-field>
    <div class="repeat-select">
      <mat-form-field>
        <mat-label>
          {{ "gpt-room-settings.usage-time-duration" | translate }}
        </mat-label>
        <input
          matInput
          appAccessibilityEscapedInput
          type="number"
          inputmode="numeric"
          pattern="[0-9]*"
          [(ngModel)]="repeatDuration" />
        <button
          *ngIf="repeatDuration !== null"
          matSuffix
          mat-icon-button
          aria-label="Clear"
          (click)="repeatDuration = null">
          <mat-icon>close</mat-icon>
        </button>
      </mat-form-field>
      <mat-form-field>
        <mat-label>
          {{ "gpt-room-settings.usage-time-unit" | translate }}
        </mat-label>
        <mat-select [(ngModel)]="repeatUnit">
          <mat-option [value]="null">
            <em>{{ "gpt-room-settings.reset" | translate }}</em>
          </mat-option>
          <mat-option
            *ngFor="let unit of possibleRepeatUnits"
            [value]="unit">
            {{ "gpt-room-settings.usage-time-values." + unit | translate }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>
    <button
      mat-button
      (click)="addUsageTime()"
      class="primary-btn">
      {{ "gpt-room-settings.add-usage-time" | translate }}
    </button>
    <mat-list>
      <mat-list-item
        class="keyword-item"
        *ngFor="let item of usageTimes; let i = index">
        <div matListItemTitle>
          {{ formatRange(item.startDate, item.endDate) }}
        </div>
        <div
          matListItemLine
          *ngIf="item.repeatDuration && item.repeatUnit">
          {{
            getRepeatString(item) | translate : { value: item.repeatDuration }
          }}
        </div>
        <button mat-icon-button>
          <mat-icon (click)="usageTimes.splice(i, 1)">close</mat-icon>
        </button>
      </mat-list-item>
    </mat-list>
  </ng-container>

  <!-- Rights setting -->
  <ng-container *ngIf="isOwner">
    <h3>{{ "gpt-room-settings.moderator-rights" | translate }}</h3>
    <mat-slide-toggle [(ngModel)]="canChangeParticipantQuota">
      {{ "gpt-room-settings.mod-right-part-quota" | translate }}
    </mat-slide-toggle>
    <mat-slide-toggle [(ngModel)]="canChangeModeratorQuota">
      {{ "gpt-room-settings.mod-right-mod-quota" | translate }}
    </mat-slide-toggle>
    <mat-slide-toggle [(ngModel)]="canChangeRoomQuota">
      {{ "gpt-room-settings.mod-right-room-quota" | translate }}
    </mat-slide-toggle>
    <mat-slide-toggle [(ngModel)]="canChangeKeywords">
      {{ "gpt-room-settings.mod-right-keywords" | translate }}
    </mat-slide-toggle>
    <mat-slide-toggle [(ngModel)]="canChangeUsageTimes">
      {{ "gpt-room-settings.mod-right-usage-times" | translate }}
    </mat-slide-toggle>
    <mat-slide-toggle [(ngModel)]="canChangeApiSettings">
      {{ "gpt-room-settings.mod-right-api-settings" | translate }}
    </mat-slide-toggle>
  </ng-container>
</mat-dialog-content>

<app-dialog-action-buttons
  [buttonsLabelSection]="'gpt-room-settings'"
  [confirmButtonLabel]="'save'"
  [cancelButtonClickAction]="buildCancelAction()"
  [confirmButtonClickAction]="buildConfirmAction()"></app-dialog-action-buttons>

<ng-template #deactivated>
  <em>{{ "gpt-room-settings.deactivated" | translate }}</em>
</ng-template>

<ng-template #loading>
  <app-mat-spinner-overlay
    color="on-surface"
    diameter="40"
    strokeWidth="5"></app-mat-spinner-overlay>
</ng-template>