<m3-body-pane>
  <m3-supporting-pane
    type="fixed"
    class="threads-overview"
    [class.open]="isOpen()">
    <mat-toolbar>
      <button
        mat-icon-button
        (click)="isOpen.set(false)">
        <mat-icon>left_panel_close</mat-icon>
      </button>
    </mat-toolbar>
    <mat-action-list>
      @if (selectedThread() !== null) {
        <button
          mat-button
          (click)="selectedThread.set(null)">
          New Chat
        </button>
      }
      @for (entry of threads(); track entry) {
        <button
          mat-list-item
          [activated]="selectedThread() === entry"
          (click)="selectedThread.set(entry)">
          <span matListItemTitle>{{ entry.headLine }}</span>
          <span>{{ entry.content }}</span>
        </button>
      } @empty {
        <div mat-subheader>Keine Threads vorhanden</div>
      }
    </mat-action-list>
  </m3-supporting-pane>
  <m3-supporting-pane
    class="chat-pane"
    type="flexible">
    <mat-toolbar>
      @if (!isOpen()) {
        <button
          mat-icon-button
          (click)="isOpen.set(true)">
          <mat-icon>left_panel_open</mat-icon>
        </button>
      }
      <span style="flex: 1"></span>
      <mat-form-field appearance="outline">
        <mat-label>Assistent</mat-label>
        <mat-select [formControl]="selectedAssistant">
          @for (entry of assistRefs(); track entry) {
            <mat-option [value]="entry.ref.id">
              {{ entry.assistant.name }}
            </mat-option>
          }
        </mat-select>
      </mat-form-field>
      <span style="flex: 1"></span>
    </mat-toolbar>
    <div style="flex: 1; overflow: auto">
      @for (message of currentMessages(); track message) {
        @if (message.role === "user") {
          <mat-card class="user-card">
            <mat-card-content>
              @for (messageContent of message.content; track messageContent) {
                @switch (messageContent.type) {
                  @case ("text") {
                    <p class="user-message">{{ messageContent.text.value }}</p>
                  }
                }
              }
            </mat-card-content>
          </mat-card>
        } @else {
          @for (messageContent of message.content; track messageContent) {
            @switch (messageContent.type) {
              @case ("text") {
                <app-markdown-viewer
                  class="assistant-message"
                  [data]="messageContent.text.value"></app-markdown-viewer>
              }
            }
          }
        }
      }
    </div>
    <div class="input-area">
      <mat-form-field
        class="input-field"
        appearance="outline">
        <mat-label>{{ i18n().input }}</mat-label>
        <textarea
          matInput
          [formControl]="inputMessage"
          [placeholder]="i18n().placeholder"
          #inputElem
          (input)="updateHeight(inputElem)"></textarea>
        <button
          mat-icon-button
          (click)="fileInput.click()"
          matPrefix>
          <mat-icon>attach_file_add</mat-icon>
          <input
            #fileInput
            (change)="onFileChange(fileInput.files)"
            type="file"
            multiple
            accept=".c,.cs,.cpp,.doc,.docx,.html,.java,.json,.md,.pdf,.php,.pptx,.py,.rb,.tex,.txt,.css,.js,.sh,.ts"
            style="display: none" />
        </button>
        <button
          mat-icon-button
          matPrefix>
          <mat-icon>more_vert</mat-icon>
        </button>
        @if (state() === "ready") {
          <button
            (click)="sendMessage()"
            mat-icon-button
            matSuffix>
            <mat-icon>send</mat-icon>
          </button>
        } @else {
          <mat-spinner
            matSuffix
            [diameter]="24"
            [strokeWidth]="2"></mat-spinner>
        }
        <mat-hint>
          @if (files().length; as length) {
            {{
              i18n().uploadedFiles
                | context
                  : {
                      count: length,
                      files: filesString()
                    }
            }}
          }
        </mat-hint>
      </mat-form-field>
    </div>
  </m3-supporting-pane>
</m3-body-pane>
